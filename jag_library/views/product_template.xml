<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <record id="product_template_form_view_inherit_is_book" model="ir.ui.view">
        <field name="name">product.template.form.inherit.is.book</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view" />
        <field name="arch" type="xml">
            <xpath expr="//div[@name='options']/span[last()]" position="after">
                <span class="d-inline-flex ms-3">
                    <field name="is_book" />
                    <label for="is_book" />
                </span>
            </xpath>
            <xpath expr="//notebook" position="inside">
                <page string="Book Information" name="book_info" invisible="is_book==False">
                    <group>
                        <group string="Publication Details">
                            <field name="publisher_id" domain="[('is_publisher', '=', True)]" context="{'default_is_company': True, 'default_is_publisher': True}" />
                            <field name="publisher_country_id" />
                            <field name="publication_date" />
                            <field name="publication_year" />
                            <field name="binding" />
                            <field name="edition" />
                            <field name="number_of_pages" />
                            <field name="language" context="{'active_test': False}" />
                        </group>
                        <group string="Library Details">
                            <field name="author_ids" widget="many2many_tags" domain="[('is_author', '=', True)]" context="{'default_is_author': True}" />
                            <field name="genre_ids" widget="many2many_tags" options="{'color_field': 'color'}" />
                            <field name="isbn" />
                            <field name="condition" />
                            <field name="copies" />
                            <field name="location" />
                        </group>
                    </group>
                    <group string="Synopsis">
                        <field name="synopsis" nolabel="1" />
                    </group>
                </page>
                <page string="Images" name="cover_image" invisible="is_book==False">
                        <group>
                            <group string="Cover Image">
                                <div class="text-center" style="max-width: 512px; margin: 0 auto;">
                                    <field name="image_1920" widget="image" nolabel="1" />
                                </div>
                            </group>
                            <group string="Back Cover">
                                <div class="text-center" style="max-width: 512px; margin: 0 auto;">
                                    <field name="image_back_cover_1920" widget="image" nolabel="1" />
                                </div>
                            </group>
                        </group>
                    </page>
                    <page string="Reading Notes" name="reading_notes" invisible="is_book==False">
                        <group>
                            <group string="Date started reading">
                                <field name="date_start_reading" nolabel="1" />
                                </group>
                            <group string="Date finished reading">
                                <field name="date_end_reading" nolabel="1" />
                            </group>
                            <group string="Rating">
                                <field name="rating" widget="priority" />
                            </group>
                        </group>
                        <group string="Reading Notes">
                            <field name="reading_notes" nolabel="1" />
                        </group>
                    </page>
                </xpath>
            <xpath expr="//header" position="inside">
                <button name="button_check_isbn" type="object" string="Verify ISBN" class="oe_highlight" invisible="not is_book" />
            </xpath>
        </field>
    </record>

    <record id="product_template_search_view_inherit_is_book" model="ir.ui.view">
        <field name="name">product.template.search.inherit.is.book</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_search_view" />
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='services']" position="after">
                <separator />
                <filter name="filter_is_book" string="Is Book" domain="[('is_book', '=', True)]" />
            </xpath>
        </field>
    </record>

    <record id="product_template_kanban_view_books" model="ir.ui.view">
        <field name="name">product.template.kanban.books.refined</field>
        <field name="model">product.template</field>
        <field name="arch" type="xml">
            <kanban records_per_row="4">
                <field name="name"/>
                <field name="image_1920"/>
                <field name="publisher_id"/>
                <field name="author_ids"/>
                <field name="number_of_pages"/>
                <field name="genre_ids"/>
                <templates>
                    <t t-name="card">
                        <!-- Contenedor principal con sombra y bordes redondeados -->
                        <div class="oe_kanban_global_click d-flex flex-row p-0 shadow-sm rounded">

                            <!-- Columna de la Imagen: Usamos <img> para un mejor control -->
                            <div class="o_kanban_image" style="flex: 0 0 150px;">
                                <img class="o_kanban_image_fill position-relative w-100" t-att-src="!record.image_1920.raw_value ? '/web/static/src/img/placeholder.png' : `/web/image/product.template/${record.id.raw_value}/image_1920`" alt="Cover"/>
                            </div>

                            <!-- Columna de Detalles -->
                            <div class="oe_kanban_details d-flex flex-column flex-grow-1 p-1" style="min-height: 180px;">
                                <div>
                                    <strong class="o_kanban_record_title mb-2 d-block"><field name="name"/></strong>
                                    <div class="text-muted">
                                        <!-- Fila de Editorial y Páginas -->
                                        <div class="d-flex mb-2">
                                            <div t-if="record.publisher_id.value" title="Editorial" class=""><i class="oi oi-building me-1"/><span style="font-weight: bold;"><field name="publisher_id"/></span></div>
                                        </div>
                                        <div class="d-flex mb-2">
                                            <div t-if="record.number_of_pages.raw_value" title="Páginas" class=""><i class="oi oi-page me-1"/><span><field name="number_of_pages"/> páginas</span></div>
                                        </div>
                                        <!-- Fila de Autores (con envoltura para las etiquetas) -->
                                        <div t-if="record.author_ids.raw_value.length > 0" title="Autor(es)" class="d-flex align-items-start">
                                            <i class="oi oi-community mt-1 flex-shrink-0"/>
                                            <div class="w-100"><field name="author_ids" widget="many2many_tags"/></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pie de Tarjeta para los Géneros -->
                                <div class="mt-auto pt-2 border-top">
                                    <div t-if="record.genre_ids.raw_value.length > 0" class="d-flex align-items-start" title="Géneros">
                                        <i class="oi oi-tag me-2 mt-1 flex-shrink-0"/>
                                        <div class="w-100"><field name="genre_ids" widget="many2many_tags" options="{'color_field': 'color'}" /></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
                <style>
                    .o_kanban_image_cover {
                        width: 100%;
                        height: 100%;
                        object-fit: cover; /* La magia para que se comporte como una portada */
                        object-position: center;
                    }
                </style>
            </kanban>
        </field>
    </record>

    <!-- ACCIÓN DE VENTANA PARA LIBROS -->
    <record id="action_product_books_kanban" model="ir.actions.act_window">
        <field name="name">Books</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="view_id" ref="jag_library.product_template_kanban_view_books"/>
        <field name="domain">[('is_book', '=', True)]</field>
        <field name="context">{'default_is_book': True}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No books created yet!
            </p>
            <p>
                Click "New" to add the first book to your catalog.
            </p>
        </field>
    </record>

    <!-- MENÚS -->
    <menuitem id="menu_product_books" name="Book Catalog" parent="jag_library.menu_library_root" action="action_product_books_kanban" sequence="10"/>
    <menuitem id="menu_product_book_genre_config" name="Book Genres" parent="jag_library.menu_library_root" action="action_product_book_genre" sequence="20" />
</odoo>
